1. Настройка MASTER

1.1. Создание пользователя для репликации


CREATE USER replicator WITH REPLICATION LOGIN PASSWORD 'replicator_password';

1.2. Настройка postgresql.conf

sudo nano /etc/postgresql/*/main/postgresql.conf

в конце файла 

listen_addresses = 'localhost,ip-address-host'
wal_level = replica
max_wal_senders =3	#количество реплик +1 
wal_keep_size = 1024MB

Сохраняем закрываем

1.3. Настройка pg_hba.conf

sudo nano /etc/postgresql/18/main/pg_hba.conf

Добавлеем правила авторизации

host    replication     replicator      ip-address-replica/32        scram-sha-256

host    all		replicator      ip-address-replica/32        scram-sha-256

1.4. Применение изменений

sudo systemctl restart postgresql

2. Настройка Реплики 

для стрим реплики, необходимо установить такую же версию PostgreSQL

2.1. Остановка PostgreSQL и очистка данных

sudo systemctl stop postgresql
sudo rm -rf /var/lib/postgresql/*/main/*

2.2. Создание базовой резервной копии

sudo -u postgres pg_basebackup -h IP-ADDRESS-MASTER -D /var/lib/postgresql/*/main/ -U replicator -P -v -R --wal-method=stream

2.3. Запуск реплики

sudo systemctl start postgresql